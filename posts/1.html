<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>信号处理 | Sparkzky&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="stylesheet" href="https://cdn.bootcss.com/prism/9000.0.1/themes/prism.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/KaTeX/0.5.1/katex.min.css">
    <script charset="utf-8" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async="true"></script>
    <link rel="icon" type="image/png" href="https://avatars.githubusercontent.com/u/146502758?s=400&amp;u=b8a39089c210f747787383af20846de9556386c8&amp;v=4">
    <meta name="description" content="Nothing to be found">
    
    <link rel="preload" href="/assets/css/0.styles.219b403a.css" as="style"><link rel="preload" href="/assets/js/app.499b976d.js" as="script"><link rel="preload" href="/assets/js/11.49d19dcf.js" as="script"><link rel="preload" href="/assets/js/4.17fba9e9.js" as="script"><link rel="preload" href="/assets/js/8.7188617a.js" as="script"><link rel="preload" href="/assets/js/16.dde07493.js" as="script"><link rel="preload" href="/assets/js/3.53e08a78.js" as="script"><link rel="prefetch" href="/assets/js/10.95b3467e.js"><link rel="prefetch" href="/assets/js/12.25d2acbb.js"><link rel="prefetch" href="/assets/js/13.a6faeee2.js"><link rel="prefetch" href="/assets/js/14.2dcd77f4.js"><link rel="prefetch" href="/assets/js/15.10998944.js"><link rel="prefetch" href="/assets/js/2.ad251a2e.js"><link rel="prefetch" href="/assets/js/5.ca9314eb.js"><link rel="prefetch" href="/assets/js/6.73dadcc7.js"><link rel="prefetch" href="/assets/js/7.e6c259d3.js"><link rel="prefetch" href="/assets/js/9.e25b7474.js">
    <link rel="stylesheet" href="/assets/css/0.styles.219b403a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="header-wrap" data-v-33920667><div class="header page" data-v-33920667><div class="left" data-v-33920667><div class="motto" data-v-33920667></div> <div class="nav" data-v-33920667></div></div> <div class="right" data-v-33920667><div class="search-box" data-v-33920667><input aria-label="Search" placeholder="" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></div> <div class="page post-page"><div class="title"><div class="post-title">信号处理</div></div> <div class="info"><div class="author">sparkzky</div> <div class="date">2025/06/13</div> <div class="count"><span id="busuanzi_value_page_pv"></span> <span>views</span></div></div> <div class="post-content"><div class="content__default"><h1 id="信号处理"><a href="#信号处理" class="header-anchor">#</a> 信号处理</h1> <hr> <h1 id="信号发送与处理详解"><a href="#信号发送与处理详解" class="header-anchor">#</a> 信号发送与处理详解</h1> <h2 id="_1-信号如何发送给目标进程"><a href="#_1-信号如何发送给目标进程" class="header-anchor">#</a> 1. 信号如何发送给目标进程</h2> <p>信号可以通过多种事件生成，例如：</p> <ul><li>用户按下特定的组合键（如 Ctrl+C 生成 SIGINT）。</li> <li>硬件异常（如除零错误生成 SIGFPE）。</li> <li>进程调用 <code>kill()</code> 系统调用发送信号。</li> <li>定时器到期（如 SIGALRM）。
信号传递给进程的过程如下：</li></ul> <ol><li>当信号生成后，内核会将信号记录在目标进程的信号位图中，对应下面的结构</li></ol> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug, Default)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">SigPending</span> <span class="token punctuation">{</span>
    signal<span class="token punctuation">:</span> <span class="token class-name">SigSet</span><span class="token punctuation">,</span>
    queue<span class="token punctuation">:</span> <span class="token class-name">SigQueue</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>然后，内核会在适当的时机调用<code>signal_pending()</code>来处理挂起的信号。这个时机通常是目标进程从内核态返回到用户态时。</li></ol> <h2 id="_2-信号的处理方法"><a href="#_2-信号的处理方法" class="header-anchor">#</a> 2. 信号的处理方法</h2> <ul><li>如果进程为该信号设置了信号处理函数（signal handler），内核会调用该处理函数。</li> <li>如果进程没有为该信号设置信号处理函数，内核会执行默认的信号处理动作（如终止进程、忽略信号等）。</li></ul> <h2 id="_3-pr889修复管道bug的原因"><a href="#_3-pr889修复管道bug的原因" class="header-anchor">#</a> 3. <a href="https://github.com/DragonOS-Community/DragonOS/pull/889" target="_blank" rel="noopener noreferrer">PR889<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>修复管道Bug的原因</h2> <p>目前尚未实现系统调用重启机制，如果系统调用返回一个 <code>ERESTARTSYS</code> 错误，会导致系统调用无法完成，使得进程状态异常，进程可能会因为资源耗尽或其他原因而被终止。上述 PR 将返回的 <code>ERESTARTSYS</code> 错误直接转换为 <code>EINTR</code>，明确用户态程序需要重新执行系统调用以解决错误。</p> <p>上面说的是针对vfs的暂时的处理方法
而对于pr中修复的pipe文件的问题，则是通过查看pipe_inode的情况来检查是否可读或可写，如果不可读不可写则会调用<code>wq_wait_event_interruptible!</code>宏来等待，使进程等待队列中睡眠，直到等待条件达成才会重新唤醒该进程，使进程重新进入执行状态，并且由于这个过程可以中断，仍可以kill进程
这个时候如果kill进程的话则会返回结果<code>Err(SystemError::ERESTARTSYS)</code>，但是未实现系统调用重启机制，则仍是交给用户态程序处理</p> <h2 id="_4-如何复现-read、write-的问题"><a href="#_4-如何复现-read、write-的问题" class="header-anchor">#</a> 4. 如何复现 read、write 的问题</h2> <p>以下代码模拟了 <code>read</code> 操作，展示了如何复现问题：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">libc<span class="token punctuation">::</span></span><span class="token punctuation">{</span>fcntl<span class="token punctuation">,</span> <span class="token constant">F_SETFL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nix<span class="token punctuation">::</span>sys<span class="token punctuation">::</span>signal<span class="token punctuation">::</span></span><span class="token punctuation">{</span>kill<span class="token punctuation">,</span> <span class="token class-name">Signal</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">nix<span class="token punctuation">::</span>unistd<span class="token punctuation">::</span></span><span class="token class-name">Pid</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token punctuation">{</span>remove_file<span class="token punctuation">,</span> <span class="token class-name">File</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Read</span><span class="token punctuation">,</span> <span class="token class-name">Result</span><span class="token punctuation">,</span> <span class="token class-name">Write</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>os<span class="token punctuation">::</span>unix<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">AsRawFd</span><span class="token punctuation">,</span> <span class="token class-name">FromRawFd</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>thread<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create and write to a large file</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token string">&quot;large_file.txt&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10_000</span> <span class="token punctuation">{</span>
            <span class="token macro property">writeln!</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;This is a line of text.&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Open the file for reading</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fd <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">as_raw_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ensure the read operation is blocking</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token constant">F_SETFL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Set to blocking mode</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Used to store the read byte data</span>
    <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">0u8</span><span class="token punctuation">;</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Use a larger buffer</span>
    <span class="token keyword">let</span> buffer_clone <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Thread 1: Simulate a blocking read operation</span>
    <span class="token keyword">let</span> handle <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">from_raw_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// Create file from raw file descriptor</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Starting blocking read operation...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">loop</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer_lock <span class="token operator">=</span> buffer_clone<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">match</span> file<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span>buffer_lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;No more data to read, exiting read&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Output the number of bytes read, occupying the entire line</span>
                    <span class="token comment">//if n != 1024 {</span>
                        <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Read {} bytes&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{:&lt;width$}&quot;</span><span class="token punctuation">,</span> output<span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Adjust width as needed</span>
                    <span class="token comment">//}</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">&quot;Read failed: {:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Thread 2: Delay sending SIGINT (Ctrl-C) signal to interrupt the blocking `read`</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5_0000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Sending SIGINT (Ctrl-C) signal to interrupt read operation...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pid <span class="token operator">=</span> <span class="token class-name">Pid</span><span class="token punctuation">::</span><span class="token function">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token class-name">Signal</span><span class="token punctuation">::</span><span class="token constant">SIGINT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to send signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Error in read thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Delete the temporary file</span>
    <span class="token function">remove_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to delete file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 Linux 上执行时，收到 Ctrl+C 会导致程序立即终止。</p> <p><img src="https://github.com/user-attachments/assets/2832c1a6-467b-4843-a8ad-7eaa58d8c2f9" alt="Image"></p> <p>但在 DragonOS 中执行时，可以看到即使程序终止，它仍然会继续读取。</p> <p><img src="https://github.com/user-attachments/assets/7368b7a8-b277-48d4-993f-6ff7de21943d" alt="Image"></p> <hr></div></div> <!----></div> <div class="footer" data-v-3ef679b5><div class="footer-content page" data-v-3ef679b5><div class="left" data-v-3ef679b5><div class="footer-title" data-v-3ef679b5>FRIEND LINKS</div> <div class="links footer-text" data-v-3ef679b5></div> <div class="footer-text" data-v-3ef679b5><span id="busuanzi_container_site_pv" class="footer-count" data-v-3ef679b5><span id="busuanzi_value_site_pv" data-v-3ef679b5></span> <span id="busuanzi_value_site_uv" data-v-3ef679b5></span></span> <div class="counter" data-v-3ef679b5><div class="counter-title" data-v-3ef679b5>PAGE VIEWS</div> <div class="counter-content" data-v-3ef679b5><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span></div></div> <div class="counter" data-v-3ef679b5><div class="counter-title" data-v-3ef679b5>USER VIEWS</div> <div class="counter-content" data-v-3ef679b5><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span><span class="counter-number" data-v-3ef679b5>0</span></div></div></div> </div> <div class="right" data-v-3ef679b5><div class="footer-title power" data-v-3ef679b5>POWERED BY</div> <a href="https://github.com/Yidadaa/Issue-Blog-With-Github-Action" class="logo" data-v-3ef679b5>ISSUE BLOG</a></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.499b976d.js" defer></script><script src="/assets/js/11.49d19dcf.js" defer></script><script src="/assets/js/4.17fba9e9.js" defer></script><script src="/assets/js/8.7188617a.js" defer></script><script src="/assets/js/16.dde07493.js" defer></script><script src="/assets/js/3.53e08a78.js" defer></script>
  </body>
</html>
